<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>לוח חידון</title>

  <style>
    :root{
      /* Theme: warm + inviting, projector-friendly */
      --bgTop:#f7f8ff;
      --bgBottom:#f2fbf7;
      --surface: rgba(255,255,255,.72);
      --surfaceBorder: rgba(20, 24, 36, .10);

      --titleGrad1:#111827;
      --titleGrad2:#0b1220;

      --catGrad1:#d9f2e1;
      --catGrad2:#cde7ff;
      --catBorder: rgba(17, 24, 39, .18);

      --cardGrad1:#4f8cff;
      --cardGrad2:#2f6bff;
      --cardBorder: rgba(255,255,255,.28);

      --levelGrad1:#eef2f7;
      --levelGrad2:#e6ebf3;
      --levelBorder: rgba(17, 24, 39, .18);

      --text:#0f172a;
      --textOnDark:#ffffff;
      --muted:#64748b;
      --shadow: 0 18px 40px rgba(15, 23, 42, .12);
      --shadowSoft: 0 10px 20px rgba(15, 23, 42, .10);
      --ring: 0 0 0 4px rgba(79, 140, 255, .25);
    }
    body{ margin:0; font-family: system-ui, Arial; color:var(--text);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(79,140,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(34,197,94,.16), transparent 55%),
                  linear-gradient(180deg, var(--bgTop), var(--bgBottom));
      min-height:100vh;
    }
    .wrap{ width: min(1120px, 96vw); margin: 22px auto; }

    /* קונטיינר עדין שנותן תחושת "לוח" */
    .panel{
      background: var(--surface);
      border: 1px solid var(--surfaceBorder);
      border-radius: 22px;
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* כותרת עליונה */
    .topTitle{
      background: linear-gradient(135deg, var(--titleGrad1), var(--titleGrad2));
      color:var(--textOnDark);
      border-radius:18px;
      padding:18px 14px;
      text-align:center;
      font-size:44px;
      font-weight:950;
      letter-spacing: .5px;
      margin-bottom: 18px;
      box-shadow: var(--shadowSoft);
    }

    /* כפתורים למעלה */
    .topActions{
      display:flex;
      gap:12px;
      justify-content:flex-start;
      margin-bottom: 14px;
    }
    .btn{
      background: rgba(17, 24, 39, .92);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      box-shadow: 0 8px 16px rgba(15, 23, 42, .12);
    }
    .btn:hover{ filter:brightness(1.06); }
    .btn:hover{ filter:brightness(1.05); }

    /* לוח: קטגוריות "בועות" למעלה + עמודת רמות מימין */
    .board{
      display:grid;
      grid-template-columns: repeat(var(--cols), 1fr) 96px; /* קטגוריות + עמודת רמות */
      gap:18px 18px;
      align-items:start;
    }

    /* עיגולי קטגוריות */
    .cat{
      height:120px;
      border-radius:60px;
      background: linear-gradient(135deg, var(--catGrad1), var(--catGrad2));
      border:1px solid var(--catBorder);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-weight:950;
      user-select:none;
      box-shadow: var(--shadowSoft);
      position:relative;
      overflow:hidden;
    }
    .cat::before{
      content:"";
      position:absolute;
      inset:-40px -40px auto auto;
      width:140px;
      height:140px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.65), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .cat .name{ font-size:26px; line-height:1.0; text-align:center; padding:0 10px; }
    .cat .num{ font-size:28px; margin-top:6px; }

    /* כרטיסי שאלות */
    .cell{
      height:78px;
      border-radius:16px;
      background: linear-gradient(135deg, var(--cardGrad1), var(--cardGrad2));
      border:1px solid var(--cardBorder);
      cursor:pointer;
      box-shadow: var(--shadowSoft);
      position:relative;
      transition: transform .12s ease, filter .12s ease;
    }
    .cell:hover{ filter:brightness(1.05); transform: translateY(-2px); }
    .cell:active{ transform: translateY(0px) scale(.99); }
    .cell:focus-visible{ outline:none; box-shadow: var(--shadowSoft), var(--ring); }
    .cell:hover{ filter:brightness(1.05); }
    .cell.used{
      background: linear-gradient(135deg, #eef2f7, #e7ebf3);
      border:1px solid rgba(17, 24, 39, .12);
      cursor:not-allowed;
      filter:none;
      box-shadow:none;
      position:relative;
    }
    .cell.used::after{
      content:"נלקח";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      letter-spacing:.5px;
      color: rgba(15, 23, 42, .45);
    }

    /* עמודת רמות */
    .lvl{
      height:78px;
      border-radius:16px;
      background: linear-gradient(135deg, var(--levelGrad1), var(--levelGrad2));
      border:1px solid var(--levelBorder);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      font-size:30px;
      user-select:none;
      box-shadow: 0 10px 18px rgba(15, 23, 42, .08);
      color: rgba(15, 23, 42, .72);
    }
    .lvlSpacer{ height:120px; }

    /* מודאל שאלה */
    .modalback{ position:fixed; inset:0; background: rgba(2,6,23,.58); display:none; align-items:center; justify-content:center; padding:18px; }
    .modal{
      width:min(900px, 96vw);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(17, 24, 39, .14);
      border-radius:22px;
      padding:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .modal h2{ margin:0 0 10px; font-size:28px; }
    .meta{ opacity:.75; font-size:14px; margin-bottom:10px; }
    .items{ margin:12px 0; display:flex; flex-wrap:wrap; gap:10px; }
    .items.vertical{ flex-direction:column; align-items:stretch; }
    .items.vertical .pill{ border-radius:14px; }
    .pill{ background: rgba(255,255,255,.85); border:1px solid rgba(17, 24, 39, .12); padding:10px 12px; border-radius:999px; font-weight:800; }
    .answer{ display:none; margin-top:12px; border-top:1px solid #ddd; padding-top:12px; }
    .modalTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }

    @media (max-width: 900px){
      .topTitle{ font-size:34px; }
      .cat{ height:100px; border-radius:50px; }
      .cat .name{ font-size:20px; }
      .cat .num{ font-size:22px; }
      .cell, .lvl{ height:68px; }
      .board{ grid-template-columns: repeat(var(--cols), 1fr) 74px; gap:14px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">

    <div class="topActions">
      <button class="btn" id="fsBtn">מסך מלא</button>
      <button class="btn" id="resetBtn">איפוס משחק</button>
    </div>

    <div class="topTitle" id="gameTitle">נושא</div>

    <div class="board" id="board"></div>

  
    </div>

  </div>

  <div class="modalback" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div>
          <h2 id="qTitle"></h2>
          <div class="meta" id="qMeta"></div>
        </div>
        <button class="btn" id="closeBtn">סגור</button>
      </div>

      <div class="items" id="qItems"></div>

      <button class="btn" id="toggleAnswerBtn">הצג תשובה</button>

      <div class="answer" id="answerBox">
        <div style="font-weight:900; margin-bottom:8px;">התשובה (הסדר הנכון):</div>
        <div class="items" id="qAnswer"></div>
      </div>
    </div>
  </div>

<script>
  // הכל נטען מקובץ config.json כדי שתערוך רק תוכן ולא קוד
  let CONFIG = null;
  let levels = [3,4,5,6];
  let questions = [];
  let categories = [];

  // מצב "נלקח" נשמר בדפדפן
  const STORAGE_KEY = "quiz_used_ids_v3";
  let usedIds = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));

  const boardEl = document.getElementById("board");
  const modalBack = document.getElementById("modalBack");
  const qTitle = document.getElementById("qTitle");
  const qMeta = document.getElementById("qMeta");
  const qItems = document.getElementById("qItems");
  const qAnswer = document.getElementById("qAnswer");
  const answerBox = document.getElementById("answerBox");
  const toggleAnswerBtn = document.getElementById("toggleAnswerBtn");
  const gameTitleEl = document.getElementById("gameTitle");

  function saveUsed() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...usedIds]));
  }

  function validateConfig(cfg){
    const errors = [];
    if (!cfg || typeof cfg !== 'object') errors.push('config.json חייב להיות אובייקט JSON.');
    if (cfg.levels && !Array.isArray(cfg.levels)) errors.push('levels חייב להיות מערך.');
    if (cfg.categories && !Array.isArray(cfg.categories)) errors.push('categories חייב להיות מערך.');
    if (cfg.questions && !Array.isArray(cfg.questions)) errors.push('questions חייב להיות מערך.');

    const qs = Array.isArray(cfg.questions) ? cfg.questions : [];
    const ids = new Set();
    for (const q of qs){
      if (!q || typeof q !== 'object') { errors.push('נמצאה שאלה שאינה אובייקט.'); continue; }
      if (!q.id) errors.push('לכל שאלה חייב להיות id.');
      if (q.id && ids.has(q.id)) errors.push(`id כפול: ${q.id}`);
      if (q.id) ids.add(q.id);
      if (!q.category) errors.push(`שאלה בלי category (id: ${q.id || 'ללא'}).`);
      if (q.difficulty == null) errors.push(`שאלה בלי difficulty (id: ${q.id || 'ללא'}).`);
      if (!Array.isArray(q.items)) errors.push(`items חייב להיות מערך (id: ${q.id || 'ללא'}).`);
      if (!Array.isArray(q.answer)) errors.push(`answer חייב להיות מערך (id: ${q.id || 'ללא'}).`);
    }
    return errors;
  }

  function firstAvailable(category, difficulty) {
    return questions.find(q => q.category===category && q.difficulty===difficulty && !usedIds.has(q.id)) || null;
  }

  function renderBoard() {
    boardEl.innerHTML = "";
    boardEl.style.setProperty("--cols", Math.max(1, categories.length));

    // שורת קטגוריות (בועות)
    for (let i = 0; i < categories.length; i++) {
      const c = categories[i];
      const cat = document.createElement("div");
      cat.className = "cat";

      const num = (CONFIG?.categoryNumbers && CONFIG.categoryNumbers[c] != null)
        ? CONFIG.categoryNumbers[c]
        : (categories.length - i);

      cat.innerHTML = `<div class="name">${c}</div><div class="num">${num}</div>`;
      boardEl.appendChild(cat);
    }

    // רווח מול עמודת הרמות
    const spacer = document.createElement("div");
    spacer.className = "lvlSpacer";
    boardEl.appendChild(spacer);

    // שורות כרטיסים + מספרי רמות מימין
    for (const lvl of levels) {
      for (const c of categories) {
        const q = firstAvailable(c, lvl);
        const cell = document.createElement("div");
        cell.className = "cell";

        if (!q) {
          cell.classList.add("used");
        } else {
          cell.onclick = () => openQuestion(q);
        }

        boardEl.appendChild(cell);
      }

      const lvlBox = document.createElement("div");
      lvlBox.className = "lvl";
      lvlBox.textContent = lvl;
      boardEl.appendChild(lvlBox);
    }
  }

  function openQuestion(q) {
    // ננעל מיד כשפותחים (כמו משחק לוח)
    usedIds.add(q.id);
    saveUsed();
    renderBoard();

    qTitle.textContent = q.prompt;
    qMeta.textContent = `${q.category} | קושי ${q.difficulty}`;
    qItems.classList.add("vertical");
    qItems.innerHTML = q.items.map(x => `<div class="pill">${x}</div>`).join("");
    qAnswer.classList.add("vertical");
    qAnswer.innerHTML = q.answer.map(x => `<div class="pill">${x}</div>`).join("");

    answerBox.style.display = "none";
    qAnswer.classList.add("vertical");
    toggleAnswerBtn.textContent = "הצג תשובה";
    modalBack.style.display = "flex";
  }

  function closeModal() {
    modalBack.style.display = "none";
  }

  document.getElementById("closeBtn").onclick = closeModal;
  modalBack.addEventListener("click", (e) => { if (e.target === modalBack) closeModal(); });

  toggleAnswerBtn.onclick = () => {
    const shown = answerBox.style.display === "block";
    answerBox.style.display = shown ? "none" : "block";
    toggleAnswerBtn.textContent = shown ? "הצג תשובה" : "הסתר תשובה";
  };

  document.getElementById("resetBtn").onclick = () => {
    usedIds = new Set();
    saveUsed();
    renderBoard();
    closeModal();
  };

  document.getElementById("fsBtn").onclick = async () => {
    if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  };

  // מקשים נוחים על מקרן
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
    if (e.key === "Enter" && modalBack.style.display === "flex") toggleAnswerBtn.click();
  });

  async function loadConfig() {
    const res = await fetch("./config.json", { cache: "no-store" });
    if (!res.ok) throw new Error("לא הצלחתי לטעון config.json");
    const cfg = await res.json();

    const errs = validateConfig(cfg);
    if (errs.length) throw new Error(errs.join("\n"));

    CONFIG = cfg;

    // כותרת משחק
    gameTitleEl.textContent = cfg.title || "נושא";

    // רמות
    levels = Array.isArray(cfg.levels) && cfg.levels.length ? cfg.levels : [3,4,5,6];

    // שאלות
    questions = Array.isArray(cfg.questions) ? cfg.questions : [];

    // קטגוריות: אם הוגדרו במפורש – לפי הסדר הזה. אחרת נגזר מהשאלות.
    categories = Array.isArray(cfg.categories) && cfg.categories.length
      ? cfg.categories
      : [...new Set(questions.map(q => q.category))];

    renderBoard();

    // “טסטים” מינימליים לקונסול (לא משפיעים על UI)
    // אם אין שאלות עדיין – זה בסדר. נציג לוח ריק עד שיוזן תוכן
    console.assert(levels.length > 0, "אין levels. הוסף levels.");
  }

  loadConfig().catch(err => {
    boardEl.style.setProperty("--cols", 1);
    boardEl.innerHTML = `<div style="grid-column:1/-1; border:2px solid #111; border-radius:14px; padding:16px; font-weight:900; white-space:pre-line;">
שגיאה בטעינת config.json:\n${String(err.message || err)}\n\nודא שקיים קובץ config.json בריפו ושה-JSON תקין.
</div>`;
  });
</script>
</body>
</html>
