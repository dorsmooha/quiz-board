<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>לוח חידון</title>

  <!-- Font: Alef (Google Fonts). If it fails, falls back to system fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Theme: dark + inviting, projector-friendly */
      --bgTop:#070a12;
      --bgBottom:#0b1220;

      --surface: rgba(255,255,255,.06);
      --surfaceBorder: rgba(255,255,255,.10);

      --titleGrad1:#0f172a;
      --titleGrad2:#111827;

      --catGrad1: rgba(34,197,94,.18);
      --catGrad2: rgba(59,130,246,.18);
      --catBorder: rgba(255,255,255,.16);

      --cardGrad1:#3b82f6;
      --cardGrad2:#1d4ed8;
      --cardBorder: rgba(255,255,255,.22);

      --levelGrad1: rgba(255,255,255,.08);
      --levelGrad2: rgba(255,255,255,.06);
      --levelBorder: rgba(255,255,255,.16);

      --text: rgba(255,255,255,.92);
      --textOnDark:#ffffff;
      --muted: rgba(255,255,255,.68);

      --shadow: 0 22px 60px rgba(0,0,0,.45);
      --shadowSoft: 0 14px 30px rgba(0,0,0,.30);
      --ring: 0 0 0 4px rgba(59, 130, 246, .35);

      --ease: cubic-bezier(.2,.8,.2,1);
    }
    body{ margin:0;
      font-family: "Alef", system-ui, -apple-system, Segoe UI, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(1000px 800px at 50% 95%, rgba(168,85,247,.14), transparent 60%),
        linear-gradient(180deg, var(--bgTop), var(--bgBottom));
      min-height:100vh;
    }
    .wrap{ width: min(1120px, 96vw); margin: 22px auto; }

    /* קונטיינר עדין שנותן תחושת "לוח" */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 26px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    /* כותרת עליונה */
    .topTitle{
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.18);
      color:var(--textOnDark);
      border-radius:22px;
      padding:18px 14px;
      text-align:center;
      font-size:46px;
      font-weight:900;
      letter-spacing: .6px;
      margin-bottom: 18px;
      box-shadow: var(--shadowSoft);
      text-transform: none;
    }

    /* כפתורים למעלה */
    .topActions{
      display:flex;
      gap:12px;
      justify-content:flex-start;
      margin-bottom: 14px;
    }
    .btn{
      background: linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.07));
      color: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:900;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      transition: transform .12s var(--ease), filter .12s var(--ease), box-shadow .12s var(--ease);
    }
    .btn:hover{ filter:brightness(1.08); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    /* לוח: קטגוריות "בועות" למעלה + עמודת רמות מימין */
    .board{
      display:grid;
      grid-template-columns: repeat(var(--cols), 1fr) 96px; /* קטגוריות + עמודת רמות */
      gap:18px 18px;
      align-items:start;
    }

    /* עיגולי קטגוריות */
    .cat{
      height:120px;
      border-radius:60px;
      background: linear-gradient(135deg, var(--catGrad1), var(--catGrad2));
      border:1px solid var(--catBorder);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-weight:950;
      user-select:none;
      box-shadow: var(--shadowSoft);
      position:relative;
      overflow:hidden;
    }
    .cat::before{
      content:"";
      position:absolute;
      inset:-50px -50px auto auto;
      width:190px;
      height:190px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 62%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .cat .name{ font-size:26px; line-height:1.0; text-align:center; padding:0 10px; }
    .cat .num{ font-size:28px; margin-top:6px; }

    /* כרטיסי שאלות */
    .cell{
      height:78px;
      border-radius:18px;
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(29,78,216,.95));
      border:1px solid rgba(255,255,255,.20);
      cursor:pointer;
      box-shadow: var(--shadowSoft);
      position:relative;
      transition: transform .14s var(--ease), filter .14s var(--ease), box-shadow .14s var(--ease);
      outline: none;
    }
    .cell::after{
      content:"";
      position:absolute;
      inset:1px;
      border-radius:16px;
      background: radial-gradient(400px 120px at 30% 20%, rgba(255,255,255,.18), transparent 55%);
      pointer-events:none;
      opacity:.85;
    }
    .cell:hover{ filter:brightness(1.06); transform: translateY(-3px); box-shadow: 0 18px 36px rgba(0,0,0,.30); }
    .cell:active{ transform: translateY(-1px) scale(.99); }
    .cell:focus-visible{ box-shadow: 0 18px 36px rgba(0,0,0,.30), var(--ring); }
    .cell:hover{ filter:brightness(1.06); transform: translateY(-3px); box-shadow: 0 18px 36px rgba(0,0,0,.30); }
    .cell:active{ transform: translateY(-1px) scale(.99); }
    .cell:focus-visible{ box-shadow: 0 18px 36px rgba(0,0,0,.30), var(--ring); }

    /* Glow קצר בלחיצה */
    @keyframes cellGlow {
      0%   { box-shadow: 0 18px 36px rgba(0,0,0,.30), 0 0 0 0 rgba(59,130,246,.0); }
      35%  { box-shadow: 0 22px 50px rgba(0,0,0,.36), 0 0 0 6px rgba(59,130,246,.22); }
      70%  { box-shadow: 0 22px 50px rgba(0,0,0,.36), 0 0 0 10px rgba(59,130,246,.18); }
      100% { box-shadow: 0 18px 36px rgba(0,0,0,.30), 0 0 0 0 rgba(59,130,246,.0); }
    }
    .cell.glow{ animation: cellGlow .55s var(--ease) both; }

    .cell.used{
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
      cursor:not-allowed;
      filter:none;
      box-shadow:none;
      position:relative;
    }
    .cell.used::after{
      content:"נלקח";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      letter-spacing:.5px;
      color: rgba(255,255,255,.45);
    }

    /* עמודת רמות */
    .lvl{
      height:78px;
      border-radius:18px;
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      font-size:30px;
      user-select:none;
      box-shadow: 0 12px 20px rgba(0,0,0,.22);
      color: rgba(255,255,255,.86);
    }
    .lvlSpacer{ height:120px; }

    /* מודאל שאלה */
    .modalback{ position:fixed; inset:0; background: rgba(0,0,0,.62); display:none; align-items:center; justify-content:center; padding:18px; }

    /* Motion: modal open/close */
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    @keyframes popIn { from { transform: translateY(18px) scale(.96); opacity:0; } to { transform: translateY(0) scale(1); opacity:1; } }

    .modalback.show{ display:flex; animation: fadeIn .18s var(--ease) both; }
    .modal{
      width:min(900px, 96vw);
      background: rgba(15, 23, 42, .72);
      color: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      padding:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      animation: popIn .22s var(--ease) both;
    }
    .modal h2{ margin:0 0 10px; font-size:28px; }
    .meta{ opacity:.75; font-size:14px; margin-bottom:10px; color: var(--muted); }
    .items{ margin:12px 0; display:flex; flex-wrap:wrap; gap:10px; }
    .items.vertical{ flex-direction:column; align-items:stretch; }
    .items.vertical .pill{
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.14);
      padding:12px 14px;
      border-radius:16px;
      font-weight:900;
      color: rgba(255,255,255,.92);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .pill .idx{ opacity:.75; font-weight:950; min-width:22px; text-align:center; }
    .pill{ background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.14); padding:10px 14px; border-radius:14px; font-weight:800; color: rgba(255,255,255,.92); display:flex; gap:10px; align-items:center; }
    .pill .idx{ opacity:.75; font-weight:900; min-width:22px; text-align:center; }
    .answer{ display:none; margin-top:12px; border-top:1px solid rgba(255,255,255,.14); padding-top:12px; }

    /* תשובה נכנסת בשורות (מדורג) */
    @keyframes lineIn { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }
    .answer.show .pill{ opacity:0; animation: lineIn .22s var(--ease) forwards; }

    /* Timer UI */
    .timerRow{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin: 10px 0 12px; }
    .timerPill{
      display:inline-flex; gap:10px; align-items:center;
      padding:10px 14px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(59,130,246,.18));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      font-weight:950;
    }
    .timerLabel{ opacity:.85; }
    .timerVal{ font-variant-numeric: tabular-nums; letter-spacing:.5px; }
    .timerPill.urgent{ background: linear-gradient(135deg, rgba(239,68,68,.24), rgba(245,158,11,.18)); }

    /* Footer brand */
    .footer{ margin-top: 14px; display:flex; justify-content:center; opacity:.8; }
    .brand{ display:flex; gap:10px; align-items:center; padding:10px 14px; border-radius:999px;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
    }
    .brand svg{ width:18px; height:18px; opacity:.9; }
    .brand span{ font-weight:900; color: rgba(255,255,255,.78); }
    .modalTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }

    @media (max-width: 900px){
      .topTitle{ font-size:34px; }
      .cat{ height:100px; border-radius:50px; }
      .cat .name{ font-size:20px; }
      .cat .num{ font-size:22px; }
      .cell, .lvl{ height:68px; }
      .board{ grid-template-columns: repeat(var(--cols), 1fr) 74px; gap:14px; }
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">

    <div class="topActions">
      <button class="btn" id="fsBtn">מסך מלא</button>
      <button class="btn" id="resetBtn">איפוס משחק</button>
    </div>

    <div class="topTitle" id="gameTitle">נושא</div>

    <div class="board" id="board"></div>

    <div class="footer">
      <div class="brand" title="Quiz Board">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 2C6.477 2 2 6.09 2 11.13c0 3.23 1.93 6.06 4.84 7.79.23 1.25-.25 2.77-1.3 3.95 2.02-.25 3.57-1.06 4.55-1.78.93.26 1.92.4 2.91.4 5.523 0 10-4.09 10-9.13S17.523 2 12 2Z" stroke="rgba(255,255,255,.75)" stroke-width="1.6"/>
          <path d="M7.5 11.2h9" stroke="rgba(255,255,255,.75)" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M7.5 14.2h6" stroke="rgba(255,255,255,.75)" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <span>Quiz Board</span>
      </div>
    </div>

    </div>

  </div>

  <div class="modalback" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div>
          <h2 id="qTitle"></h2>
          <div class="meta" id="qMeta"></div>
        </div>
        <button class="btn" id="closeBtn">סגור</button>
      </div>

      <div class="items" id="qItems"></div>

      <div class="timerRow" aria-live="polite">
        <div class="timerPill" id="timerPill">
          <span class="timerLabel">זמן:</span>
          <span class="timerVal" id="timerVal">01:00</span>
        </div>
        <button class="btn" id="startTimerBtn">התחל טיימר (60ש׳)</button>
        <button class="btn" id="resetTimerBtn">איפוס טיימר</button>
      </div>

      <button class="btn" id="toggleAnswerBtn">הצג תשובה</button>

      <div class="answer" id="answerBox">
        <div style="font-weight:900; margin-bottom:8px;">התשובה (הסדר הנכון):</div>
        <div class="items" id="qAnswer"></div>
      </div>
    </div>
  </div>

<script>
  // הכל נטען מקובץ config.json כדי שתערוך רק תוכן ולא קוד
  let CONFIG = null;
  let levels = [3,4,5,6];
  let questions = [];
  let categories = [];

  // מצב "נלקח" נשמר בדפדפן
  const STORAGE_KEY = "quiz_used_ids_v3";
  let usedIds = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));

  const boardEl = document.getElementById("board");
  const modalBack = document.getElementById("modalBack");
  const qTitle = document.getElementById("qTitle");
  const qMeta = document.getElementById("qMeta");
  const qItems = document.getElementById("qItems");
  const qAnswer = document.getElementById("qAnswer");
  const answerBox = document.getElementById("answerBox");
  const timerVal = document.getElementById("timerVal");
  const timerPill = document.getElementById("timerPill");
  const startTimerBtn = document.getElementById("startTimerBtn");
  const resetTimerBtn = document.getElementById("resetTimerBtn");

  let timerId = null;
  let remaining = 60;
  const toggleAnswerBtn = document.getElementById("toggleAnswerBtn");
  const gameTitleEl = document.getElementById("gameTitle");

  function saveUsed() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...usedIds]));
  }

  function validateConfig(cfg){
    const errors = [];
    if (!cfg || typeof cfg !== 'object') errors.push('config.json חייב להיות אובייקט JSON.');
    if (cfg.levels && !Array.isArray(cfg.levels)) errors.push('levels חייב להיות מערך.');
    if (cfg.categories && !Array.isArray(cfg.categories)) errors.push('categories חייב להיות מערך.');
    if (cfg.questions && !Array.isArray(cfg.questions)) errors.push('questions חייב להיות מערך.');

    const qs = Array.isArray(cfg.questions) ? cfg.questions : [];
    const ids = new Set();
    for (const q of qs){
      if (!q || typeof q !== 'object') { errors.push('נמצאה שאלה שאינה אובייקט.'); continue; }
      if (!q.id) errors.push('לכל שאלה חייב להיות id.');
      if (q.id && ids.has(q.id)) errors.push(`id כפול: ${q.id}`);
      if (q.id) ids.add(q.id);
      if (!q.category) errors.push(`שאלה בלי category (id: ${q.id || 'ללא'}).`);
      if (q.difficulty == null) errors.push(`שאלה בלי difficulty (id: ${q.id || 'ללא'}).`);
      if (!Array.isArray(q.items)) errors.push(`items חייב להיות מערך (id: ${q.id || 'ללא'}).`);
      if (!Array.isArray(q.answer)) errors.push(`answer חייב להיות מערך (id: ${q.id || 'ללא'}).`);
    }
    return errors;
  }

  function firstAvailable(category, difficulty) {
    return questions.find(q => q.category===category && q.difficulty===difficulty && !usedIds.has(q.id)) || null;
  }

  function renderBoard() {
    boardEl.innerHTML = "";
    boardEl.style.setProperty("--cols", Math.max(1, categories.length));

    // שורת קטגוריות (בועות)
    for (let i = 0; i < categories.length; i++) {
      const c = categories[i];
      const cat = document.createElement("div");
      cat.className = "cat";

      const num = (CONFIG?.categoryNumbers && CONFIG.categoryNumbers[c] != null)
        ? CONFIG.categoryNumbers[c]
        : (categories.length - i);

      cat.innerHTML = `<div class="name">${c}</div><div class="num">${num}</div>`;
      boardEl.appendChild(cat);
    }

    // רווח מול עמודת הרמות
    const spacer = document.createElement("div");
    spacer.className = "lvlSpacer";
    boardEl.appendChild(spacer);

    // שורות כרטיסים + מספרי רמות מימין
    for (const lvl of levels) {
      for (const c of categories) {
        const q = firstAvailable(c, lvl);
        const cell = document.createElement("div");
        cell.className = "cell";

        if (!q) {
          cell.classList.add("used");
        } else {
          cell.onclick = () => openQuestion(q, cell);
        }

        boardEl.appendChild(cell);
      }

      const lvlBox = document.createElement("div");
      lvlBox.className = "lvl";
      lvlBox.textContent = lvl;
      boardEl.appendChild(lvlBox);
    }
  }

  function openQuestion(q, sourceEl) {
    // Glow קצר על התא שנלחץ
    if (sourceEl) {
      sourceEl.classList.add("glow");
      setTimeout(() => sourceEl.classList.remove("glow"), 650);
    }

    // ננעל מיד כשפותחים (כמו משחק לוח)
    usedIds.add(q.id);
    saveUsed();
    renderBoard();

    qTitle.textContent = q.prompt;
    qMeta.textContent = `${q.category} | קושי ${q.difficulty}`;

    qItems.classList.add("vertical");
    qItems.innerHTML = q.items.map((x,i) => `<div class="pill"><span class="idx">${i+1}.</span><span>${x}</span></div>`).join("");

    // חשוב: נטען תשובה, אבל לא מציגים עד לחיצה על "הצג תשובה"
    qAnswer.classList.add("vertical");
    qAnswer.innerHTML = q.answer.map((x,i) => `<div class="pill"><span class="idx">${i+1}.</span><span>${x}</span></div>`).join("");

    answerBox.style.display = "none";
    answerBox.classList.remove("show");
    toggleAnswerBtn.textContent = "הצג תשובה";

    // טיימר: מאפסים בכל פתיחת שאלה, ומתחילים אוטומטית
    resetTimer();
    startTimer();

    modalBack.classList.add("show");
  }

  function closeModal() {
    stopTimer();
    modalBack.classList.remove("show");
  }

  document.getElementById("closeBtn").onclick = closeModal;
  modalBack.addEventListener("click", (e) => { if (e.target === modalBack) closeModal(); });

  toggleAnswerBtn.onclick = () => {
    const shown = answerBox.style.display === "block";

    if (shown) {
      answerBox.style.display = "none";
      answerBox.classList.remove("show");
      toggleAnswerBtn.textContent = "הצג תשובה";
      return;
    }

    // הצג + אנימציה מדורגת לפריטים
    answerBox.style.display = "block";
    answerBox.classList.add("show");

    const pills = qAnswer.querySelectorAll(".pill");
    pills.forEach((p, i) => {
      p.style.animationDelay = `${i * 90}ms`;
    });

    toggleAnswerBtn.textContent = "הסתר תשובה";
  }; 

  function formatTime(sec){
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    const mm = String(m).padStart(2,'0');
    const ss = String(s).padStart(2,'0');
    return `${mm}:${ss}`;
  }

  function renderTimer(){
    timerVal.textContent = formatTime(remaining);
    if (remaining <= 10) timerPill.classList.add('urgent');
    else timerPill.classList.remove('urgent');
  }

  function stopTimer(){
    if (timerId) { clearInterval(timerId); timerId = null; }
  }

  function resetTimer(){
    stopTimer();
    remaining = 60;
    renderTimer();
  }

  function startTimer(){
    stopTimer();
    renderTimer();
    timerId = setInterval(() => {
      remaining -= 1;
      renderTimer();
      if (remaining <= 0) {
        stopTimer();
        // כשהזמן נגמר: נותנים רמז ויזואלי קטן
        timerPill.classList.add('urgent');
      }
    }, 1000);
  }

  startTimerBtn.onclick = startTimer;
  resetTimerBtn.onclick = resetTimer;

  document.getElementById("resetBtn").onclick = () => {
    usedIds = new Set();
    saveUsed();
    renderBoard();
    closeModal();
  };

  document.getElementById("fsBtn").onclick = async () => {
    if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  };

  // מקשים נוחים על מקרן
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
    if (e.key === "Enter" && modalBack.classList.contains("show")) toggleAnswerBtn.click();
  });

  async function loadConfig() {
    const res = await fetch("./config.json", { cache: "no-store" });
    if (!res.ok) throw new Error("לא הצלחתי לטעון config.json");
    const cfg = await res.json();

    const errs = validateConfig(cfg);
    if (errs.length) throw new Error(errs.join("\n"));

    CONFIG = cfg;

    // כותרת משחק
    gameTitleEl.textContent = cfg.title || "נושא";

    // רמות
    levels = Array.isArray(cfg.levels) && cfg.levels.length ? cfg.levels : [3,4,5,6];

    // שאלות
    questions = Array.isArray(cfg.questions) ? cfg.questions : [];

    // קטגוריות: אם הוגדרו במפורש – לפי הסדר הזה. אחרת נגזר מהשאלות.
    categories = Array.isArray(cfg.categories) && cfg.categories.length
      ? cfg.categories
      : [...new Set(questions.map(q => q.category))];

    renderBoard();

    // “טסטים” מינימליים לקונסול (לא משפיעים על UI)
    // אם אין שאלות עדיין – זה בסדר. נציג לוח ריק עד שיוזן תוכן
    console.assert(levels.length > 0, "אין levels. הוסף levels.");
  }

  loadConfig().catch(err => {
    boardEl.style.setProperty("--cols", 1);
    boardEl.innerHTML = `<div style="grid-column:1/-1; border:2px solid #111; border-radius:14px; padding:16px; font-weight:900; white-space:pre-line;">
שגיאה בטעינת config.json:\n${String(err.message || err)}\n\nודא שקיים קובץ config.json בריפו ושה-JSON תקין.
</div>`;
  });
</script>
</body>
</html>
